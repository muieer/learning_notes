# Java 对象布局和对象指针压缩

本篇文章讨论在 HotSpot JVM 中，Java 对象在堆内存中的布局方式和对象指针压缩方式。

## 一 对象布局

Java 对象布局由三部分数据组成。

第一部分是对象头。对象头由 mark word 和 klass word 组成。在 64 位操作系统中，mark word 占用 8 字节。klass word 占用 4 字节。如果是数组，还会有 4 字节用来记录数组长度。

第二部分是实例数据。就是对象持有的实例变量。分为基本类型和引用类型实例变量。基本类型变量占用内存和他们自身大小一致（布尔类型占用一字节内存）。如果没有开启对象指针压缩，引用类型变量占用 8 字节内存，开启的话，引用类型变量占用 4 字节内存。

第三部分是对齐填充的空白数据。每个对象占用的内存必须是 8 字节的整数倍。当对象占用内存大小不为 8 字节的整数倍时，需要填充空白数据，直至满足该要求。

普通对象或数组对象，占用堆内存至少为 16 字节。普通对象对象头占用 12 字节内存，还有 4 字节需要用来填充实例数据或对其填充的空白数据。

## 二 对象内存占用计算或统计方式

**2.1 JOL**

[JOL](https://github.com/openjdk/jol) 是 OpenJDK 提供的用来分析对象内存占用的工具。

**2.2 对象内存占用直方图**

终端输入 `jcmd pid GC.class_histogram`，可以生成正在运行的 Java 进程对象占用堆内存的直方图。

**2.3 堆转储文件**

堆转储文件是在一个确定时间点堆内存中对象信息的快照。该快照记录的信息有对象的数量和内存占用大小，对象的类变量和实例变量，引用信息和 GC Root。

终端输入 `jcmd pid GC.heap_dump /path/to/heap_dump.hprof` 或 `jmap -dump:live,file=/path/to/heap_dump.hprof pid` 可以生成堆转储文件。

[MAT](https://eclipse.dev/mat/) 和 [VisualVM](https://github.com/oracle/visualvm) 是查看堆转储文件的可视化工具。

## 三 对象指针压缩

Java 默认是开启对象指针压缩。这种情况下，指针占用内存大小为 4 字节。添加虚拟机配置参数 `-XX:-UseCompressedOops` 可以关闭对象指针压缩。

开启对象指针压缩的好处是节省内存。坏处是最大只支持 32 GB 堆内存的读写。

开启对象指针压缩时，指针占用内存大小为 4 字节，最大只能支持 32GB 堆内存读写。因为对象占用内存必须是 8 字节的整数倍，所以指针在记录对象在内存中的起始地址时会右移三位，读取数据时指针数值会左移三位找到实际的起始内存地址。这样就实现了使用 4 字节大小指针读写 32 GB 堆内存的能力。

## 四 指针压缩和对其填充的性能权衡

如果要用 4 字节的指针支持最大 64 GB 的堆内存读写，那么对其填充的要求就会是对象占用的内存必须是 16 字节的整数倍。16 字节对其填充大量无效数据可能会抵消指针压缩带来的好处。

如果不使用对其填充，数据紧密排布，那 4 字节的指针只能支持最大 4GB 堆内存读写。 

CPU 有 16、32、64 位寄存器。如果指针大小为 35 位（用一个 16 位和 32 位寄存器存储），不采用对其填充，能支持 32 GB 堆内存读写，但需要两次寻址。

所以说，在开启指针压缩（指针大小为 4 字节）和 8 字节对其填充的情况下，时间效率和空间效率得到了很好的平衡。

## 四 参考连接

- [Memory Layout of Objects in Java](https://www.baeldung.com/java-memory-layout), by Baeldung
