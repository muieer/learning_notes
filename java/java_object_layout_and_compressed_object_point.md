# Java 对象布局和对象指针压缩

## 对象布局

Java 对象是存储在堆中，所以此处讲的对象布局是指对象在堆中的布局方式，并且特指 HotSpot JVM。

Java 对象由三部分数据组成。

第一部分是对象头。对象头由 mark word 和 klass word 组成。在 64 位操作系统中，mark word 占用 8 字节。klass word 占用 4 字节。如果是数组，还会有 4 字节用来记录数组长度。

第二部分是实例数据。就是对象持有的实例变量。分为基本类型和引用类型。基本类型占用内存和他们自身大小一致（布尔类型占用一字节内存）。如果没有开启对象指针压缩，引用类型占用 8 字节，开启的话，引用类型占用 4 字节。

第三部分是填充的空白数据。每个对象占用的内存必须是 8 字节的整数倍。当对象占用内存大小不为 8 字节的整数倍时，需要填充空白数据，直至满足该要求。

## 对象内存占用计算工具

普通对象或数组对象，占用堆内存至少为 16 字节。

**JOL**

[JOL](https://github.com/openjdk/jol) 是 OpenJDK 提供的用来分析对象内存占用的工具。

**jcmd 命令行工具**

终端输入 `jcmd pid GC.class_histogram` 可以查看正在运行的 Java 进程对象占用堆内存的明细数据。

## 对象指针压缩

Java 默认是开启对象指针压缩。这种情况下，指针占用内存大小为 4 字节。添加虚拟机配置参数 `-XX:-UseCompressedOops` 可以关闭对象指针压缩。

开启对象指针压缩的好处是节省内存。坏处是最大只支持 32 GB 堆内存的读写。

开启对象指针压缩时，指针占用内存大小为 4 字节，最大只能表示 4GB 内存。但因为对象占用内存必须是 8 字节的整数倍，所以指针在记录对象在内存中的起始地址时会右移三位，读取数据时指针数值会左移三位找到实际的内存地址。

要求对象占用内存是 8 字节的整数倍，是空间换时间思想的体现，只需一次寻址。

## 参考连接

- [Memory Layout of Objects in Java](https://www.baeldung.com/java-memory-layout), by Baeldung




